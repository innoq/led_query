#META infer: <%= !!include_descendants %>

PREFIX dct:<http://purl.org/dc/terms/>
PREFIX skos:<http://www.w3.org/2004/02/skos/core#>
PREFIX qb:<http://purl.org/linked-data/cube#>
PREFIX led:<http://data.uba.de/led/>
PREFIX dcat:<http://www.w3.org/ns/dcat#>
PREFIX foaf:<http://xmlns.com/foaf/0.1/>

SELECT DISTINCT
    ?obs ?title ?description ?pdf_link ?edited_at ?providername ?partnername
WHERE {
    <%= render.call("_concepts_query",
            :concepts_by_dimension => concepts_by_dimension,
            :include_descendants => include_descendants) %>

	OPTIONAL{
    	?obs led:provider-name ?providername .		
	}
	OPTIONAL {
		?obs led:partner-name ?partnername .		
	}

    ?obs a qb:Observation .
    
    ?obs dct:modified ?edited_at .
    
    OPTIONAL{
     ?obs rdf:seeAlso ?node .
     ?node foaf:page ?pdf_link .
    }
    OPTIONAL {
      ?obs dct:title ?selectedLangTitle
      FILTER(LANGMATCHES(LANG(?selectedLangTitle), 'de'))
    }
    OPTIONAL {
      ?obs dct:title ?defaultLangTitle
      FILTER(LANGMATCHES(LANG(?defaultLangTitle), 'en'))
    }
    OPTIONAL {
      ?obs dct:title ?noLangTitle
      FILTER(LANGMATCHES(LANG(?noLangTitle), ''))
    }
    BIND(STR(COALESCE(?selectedLangTitle,?defaultLangTitle,?noLangTitle ,'missing title')) AS ?title)
    
    OPTIONAL {
      ?obs dct:description ?selectedLangDescription
      FILTER(LANGMATCHES(LANG(?selectedLangDescription), 'de'))
    }
    OPTIONAL {
      ?obs dct:description ?defaultLangDescription
      FILTER(LANGMATCHES(LANG(?defaultLangDescription), 'en'))
    }
    OPTIONAL {
      ?obs dct:description ?noLangDescription
      FILTER(LANGMATCHES(LANG(?noLangDescription), ''))
    }
    BIND(STR(COALESCE(?selectedLangDescription,?defaultLangDescription,?noLangDescription ,'missing description')) AS ?description)
    
    <%= render.call("_temporal_query",
            :temporal => temporal) %>
    <%= render.call("_keywords_query", :keywords => keywords) unless keywords.empty? %>
    <%= render.call('_title_query', :title => title) if title.present? %>
}
ORDER BY ?obs
<% if limit %>
LIMIT <%= limit %>
OFFSET <%= offset || 0 %>
<% end %>
